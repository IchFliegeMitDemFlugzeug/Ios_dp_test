<!doctype html> <!-- Объявляем HTML5-документ, чтобы Safari корректно распознал разметку -->
<html lang="ru"> <!-- Указываем язык страницы: русский -->
<head> <!-- Начало блока head: метаданные, заголовок, стили -->
  <meta charset="utf-8"> <!-- Кодировка UTF-8, чтобы русские символы отображались правильно -->
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Адаптация под экран iPhone: правильный масштаб -->
  <title>iOS DP схемы — диагностика</title> <!-- Заголовок вкладки Safari -->

  <style> /* Начало CSS: делаем простой аккуратный интерфейс */
    body { /* Стили для всей страницы */
      margin: 0; /* Убираем стандартные отступы браузера */
      padding: 20px; /* Добавляем комфортные поля вокруг контента */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; /* Системный шрифт (лучше на iOS) */
      background: #f6f7f9; /* Светлый фон */
      color: #111; /* Тёмный текст */
    } /* Конец стилей body */

    .card { /* Карточка-контейнер для основного блока */
      max-width: 720px; /* Ограничиваем ширину, чтобы текст был читаемым */
      margin: 0 auto; /* Центрируем карточку по горизонтали */
      background: #fff; /* Белый фон карточки */
      border-radius: 16px; /* Скругление углов */
      padding: 16px; /* Внутренние отступы */
      box-shadow: 0 8px 22px rgba(0,0,0,0.10); /* Лёгкая тень */
    } /* Конец стилей .card */

    h1 { /* Стили заголовка */
      margin: 0 0 10px 0; /* Отступы вокруг заголовка */
      font-size: 18px; /* Размер шрифта заголовка */
    } /* Конец стилей h1 */

    p { /* Стили абзацев */
      margin: 8px 0; /* Небольшие отступы сверху/снизу */
      color: #333; /* Чуть более мягкий цвет текста */
      line-height: 1.45; /* Межстрочный интервал для удобства чтения */
      font-size: 13px; /* Размер текста */
    } /* Конец стилей p */

    .btn { /* Стили для кнопки запуска теста */
      display: inline-block; /* Кнопка как блочный элемент в строке */
      padding: 12px 14px; /* Размер кнопки */
      border: 0; /* Без рамки */
      border-radius: 12px; /* Скругление углов */
      background: #111; /* Чёрный фон кнопки */
      color: #fff; /* Белый текст */
      font-size: 14px; /* Размер текста на кнопке */
      cursor: pointer; /* Курсор-рука при наведении */
      width: 100%; /* Кнопка на всю ширину карточки (удобно на телефоне) */
    } /* Конец стилей .btn */

    .btn:active { /* Эффект при нажатии */
      transform: scale(0.99); /* Лёгкое “вдавливание” */
    } /* Конец :active */

    code { /* Стили для блоков кода (показываем собираемые URL) */
      display: block; /* Делает блок кода отдельной строкой */
      margin-top: 10px; /* Отступ сверху */
      padding: 10px; /* Внутренние отступы */
      background: #f1f3f5; /* Серый фон */
      border-radius: 10px; /* Скругление */
      overflow-x: auto; /* Горизонтальная прокрутка для длинных строк */
      white-space: pre; /* Не переносим строки автоматически */
      font-size: 12px; /* Мелкий шрифт */
    } /* Конец стилей code */

    .log { /* Стили для лога попыток */
      margin-top: 12px; /* Отступ сверху */
      padding: 10px; /* Внутренние отступы */
      background: #fafafa; /* Почти белый фон */
      border-radius: 12px; /* Скругление */
      border: 1px solid #eee; /* Тонкая рамка */
      font-size: 13px; /* Размер текста */
      line-height: 1.35; /* Межстрочный интервал */
      max-height: 320px; /* Ограничиваем высоту лога */
      overflow: auto; /* Если много строк — появится прокрутка */
    } /* Конец стилей .log */

    .ok { /* Стили для успешного статуса */
      color: #1a7f37; /* Зелёный цвет текста */
      font-weight: 600; /* Полужирный */
    } /* Конец .ok */

    .bad { /* Стили для неуспешного статуса */
      color: #b42318; /* Красноватый цвет текста */
      font-weight: 600; /* Полужирный */
    } /* Конец .bad */

    .muted { /* Стили для “приглушённого” текста */
      color: #666; /* Серый */
      font-size: 12px; /* Чуть меньший текст */
    } /* Конец .muted */
  </style> <!-- Конец CSS -->
</head> <!-- Конец head -->

<body> <!-- Начало body -->
  <div class="card"> <!-- Основная карточка интерфейса -->
    <h1>Диагностика iOS custom-schemes (тихо, без «адрес недействителен»)</h1> <!-- Заголовок страницы -->

    <p>Эта страница пробует открыть приложение через разные iOS-схемы из твоего <b>logic.js</b>, но делает это через скрытый <b>iframe</b>, чтобы Safari не уходил на ошибку.</p> <!-- Короткое пояснение -->
    <p class="muted">Важно: iOS может показать системный диалог «Открыть в приложении?» — это нормально и не отключается на сайте.</p> <!-- Важное примечание -->

    <button id="startBtn" class="btn">Запустить тест (нужен один тап)</button> <!-- Кнопка старта (тап нужен, чтобы iOS охотнее разрешал открытия) -->

    <div id="status" class="muted" style="margin-top:10px;">Статус: ожидаю запуска…</div> <!-- Текстовый статус процесса -->

    <code id="deepLinkPreview"></code> <!-- Покажем, какой “путь+параметры” мы подставляем после схемы -->

    <div id="log" class="log"></div> <!-- Лог всех попыток: какие схемы пробовали и что заметили -->
  </div> <!-- Конец карточки -->

  <script> // Начало JavaScript-логики страницы

    // -----------------------------
    // 1) НАСТРОЙКИ ПАРАМЕТРОВ (ТЫ МОЖЕШЬ МЕНЯТЬ)
    // -----------------------------

    const PHONE_NUMBER = "79160794459"; // Номер телефона в формате 79XXXXXXXXX (без +, пробелов и дефисов) — так надёжнее всего
    const EXTERNAL_SOURCE_RAW = "pbpn-_-test"; // Трекинг-строка (в “сыром” виде) — мы её безопасно закодируем

    // -----------------------------
    // 2) СПИСОК iOS-СХЕМ (ИЗ ТВОЕГО logic.js)
    // -----------------------------
    // Важно: мы пробуем ВСЕ схемы, которые в файле помечены как platform:"ios".
    // Часть из них может относиться не к СберБанк Онлайн, но задача — выяснить, какая схема реально зарегистрирована на твоём iPhone.

    const IOS_SCHEMES = [ // Массив схем без :// (чистое имя схемы)
      "friendinvest", // Схема из logic.js (iOS)
      "driveinvest", // Схема из logic.js (iOS)
      "sudokustrategyapp", // Схема из logic.js (iOS)
      "investsphere", // Схема из logic.js (iOS)
      "investorplus", // Схема из logic.js (iOS)
      "newinvestor", // Схема из logic.js (iOS)
      "onlineios-app", // Похоже на один из вариантов “онлайн” приложения
      "onlineappmobile", // Ещё один вариант “онлайн” приложения
      "app-online-ios", // Ещё один вариант “онлайн” приложения
      "budgetonline-ios", // Ещё одна схема, которую логика умеет пробовать
      "ios-app-smartonline", // Вариант smartonline
      "btripsexpenses", // Схема из logic.js (iOS)
      "sbolonline", // Часто встречается как альтернативная схема Сбера
      "sberbankonline" // То, что ты пробовал вручную (у тебя не открылось)
    ]; // Конец массива IOS_SCHEMES

    // -----------------------------
    // 3) СОБИРАЕМ ОБЩУЮ “ХВОСТОВУЮ” ЧАСТЬ (ПУТЬ + QUERY)
    // -----------------------------
    // Мы используем тот же путь, что ты хотел: /payments/p2p-by-phone-number, и те же ключевые параметры.
    // Значения параметров кодируем, чтобы в URL не было “опасных” символов, которые ломают адрес.

    const PATH_AND_QUERY = ( // Строка, которая будет добавляться после scheme://
      "payments/p2p-by-phone-number" + // Путь внутри приложения (как у тебя)
      "?source=" + encodeURIComponent("QR_FROM_SELF_EMPLOYED_EXTERNAL") + // Параметр source с нужной меткой (кодируем)
      "&phoneNumber=" + encodeURIComponent(PHONE_NUMBER) + // Параметр phoneNumber (кодируем)
      "&external_source=" + encodeURIComponent(EXTERNAL_SOURCE_RAW) // Параметр external_source (кодируем)
    ); // Конец PATH_AND_QUERY

    // Показываем пользователю, что именно мы будем подставлять после схемы (для контроля).
    document.getElementById("deepLinkPreview").textContent = "PATH+QUERY: " + PATH_AND_QUERY; // Выводим строку под кнопкой

    // -----------------------------
    // 4) СЛУЖЕБНЫЕ ФУНКЦИИ ДЛЯ UI (ЛОГ И СТАТУС)
    // -----------------------------

    const logEl = document.getElementById("log"); // Получаем элемент, куда будем писать лог
    const statusEl = document.getElementById("status"); // Получаем элемент, где показываем статус
    const startBtn = document.getElementById("startBtn"); // Получаем кнопку запуска

    function logLine(text) { // Функция: добавить строку в лог
      const div = document.createElement("div"); // Создаём новый div для строки лога
      div.textContent = text; // Записываем в него текст
      logEl.appendChild(div); // Добавляем строку в конец лога
      logEl.scrollTop = logEl.scrollHeight; // Прокручиваем лог вниз, чтобы была видна последняя строка
    } // Конец logLine

    function setStatus(text) { // Функция: обновить статус
      statusEl.textContent = "Статус: " + text; // Пишем новый статус в элемент
    } // Конец setStatus

    // -----------------------------
    // 5) КЛЮЧЕВОЙ ТРЮК: ПРОБУЕМ СХЕМЫ ЧЕРЕЗ HIDDEN IFRAME
    // -----------------------------
    // Почему iframe:
    // - Если делать window.location = "unknownscheme://..." — Safari может перейти на страницу ошибки “адрес недействителен”.
    // - Если делать iframe.src = "unknownscheme://..." — чаще всего это проходит тихо (без ошибки страницы).
    // - Если схема реально зарегистрирована приложением, iOS откроет приложение.

    let probeFrame = null; // Переменная, где будем хранить созданный iframe

    function ensureProbeFrame() { // Функция: создать iframe один раз и переиспользовать
      if (probeFrame) { // Если iframe уже создан
        return; // Ничего не делаем (он уже есть)
      } // Конец проверки

      probeFrame = document.createElement("iframe"); // Создаём iframe
      probeFrame.style.display = "none"; // Делаем его невидимым (чтобы не портил интерфейс)
      probeFrame.style.width = "0"; // На всякий случай задаём нулевую ширину
      probeFrame.style.height = "0"; // На всякий случай задаём нулевую высоту
      probeFrame.style.border = "0"; // Убираем рамку
      document.body.appendChild(probeFrame); // Добавляем iframe в DOM, чтобы он реально существовал
    } // Конец ensureProbeFrame

    // -----------------------------
    // 6) ДЕТЕКТ “ОТКРЫЛОСЬ ЛИ ПРИЛОЖЕНИЕ”
    // -----------------------------
    // Самый практичный способ без Mac: если приложение открылось, страница обычно уходит в фон -> document.hidden становится true.
    // Мы ловим это событие и считаем, что схема “сработала”.

    let openedByScheme = null; // Тут сохраним схему, на которой страница “ушла в фон”
    let testing = false; // Флаг: идёт ли сейчас тест

    document.addEventListener("visibilitychange", () => { // Подписываемся на изменение видимости страницы
      if (document.hidden && testing) { // Если страница стала скрытой И мы в процессе теста
        // В этот момент iOS, как правило, переключил нас в приложение.
        // Мы не можем на 100% знать, что именно открылось, но это лучший доступный признак.
        // Схему мы запомним в момент запуска попытки (см. ниже).
      } // Конец if
    }); // Конец подписки

    // -----------------------------
    // 7) ОСНОВНОЙ ТЕСТ: ПО ОЧЕРЕДИ ПРОБУЕМ ВСЕ СХЕМЫ
    // -----------------------------

    function sleep(ms) { // Функция: пауза ms миллисекунд
      return new Promise(resolve => setTimeout(resolve, ms)); // Возвращаем Promise, который завершится через ms
    } // Конец sleep

    async function runTest() { // Асинхронная функция: запускает полный перебор схем
      testing = true; // Отмечаем, что тест начался
      openedByScheme = null; // Сбрасываем результат
      startBtn.disabled = true; // Блокируем кнопку, чтобы не запустить тест повторно
      logEl.innerHTML = ""; // Очищаем лог перед началом теста
      setStatus("тест запущен, перебираю схемы…"); // Пишем статус
      logLine("Начинаю перебор iOS-схем (через hidden iframe)…"); // Пишем первую строку лога

      ensureProbeFrame(); // Гарантируем, что iframe создан

      // Мы будем хранить “текущую пробуемую схему”, чтобы в момент ухода в фон знать, что сработало.
      let currentScheme = null; // Переменная под текущую схему

      // Отдельно поставим слушатель visibilitychange, который запоминает currentScheme при уходе в фон.
      const visHandler = () => { // Функция-обработчик события
        if (document.hidden && testing && currentScheme) { // Если ушли в фон во время теста, и currentScheme задана
          openedByScheme = currentScheme; // Запоминаем схему, на которой это произошло
        } // Конец if
      }; // Конец visHandler

      document.addEventListener("visibilitychange", visHandler); // Подписываемся на событие, чтобы ловить момент открытия приложения

      try { // Оборачиваем тест в try/finally, чтобы гарантированно снять обработчик и разблокировать кнопку
        for (const scheme of IOS_SCHEMES) { // Проходим по всем схемам из массива
          if (openedByScheme) { // Если уже зафиксировали уход в фон (приложение открылось)
            break; // Прекращаем перебор, дальше не нужно
          } // Конец if

          currentScheme = scheme; // Запоминаем, что именно сейчас пробуем (нужно для фиксации результата)

          // Собираем полный URL для попытки открытия.
          const url = scheme + "://" + PATH_AND_QUERY; // Склеиваем: scheme:// + путь+параметры

          logLine("Пробую: " + url); // Пишем в лог, какой URL сейчас пробуем
          setStatus("пробую схему: " + scheme); // Обновляем статус

          // Пробуем “тихо” через iframe.
          // Важно: try/catch тут почти ничего не ловит, потому что Safari часто не кидает JS-исключение,
          // но на всякий случай оставляем.
          try { // Начало попытки
            probeFrame.src = url; // Устанавливаем src iframe на custom-scheme URL (должно быть тихо, без error-page)
          } catch (e) { // Если вдруг браузер кинул исключение
            logLine("  ⚠️ JS-исключение при попытке (это редкость): " + String(e)); // Пишем в лог, что было исключение
          } // Конец try/catch

          // Ждём немного, чтобы iOS успел либо открыть приложение, либо “ничего не сделать”.
          await sleep(700); // Пауза 700 мс — компромисс между скоростью и шансом успеть открыть приложение

          // Если в этот момент страница уже ушла в фон, мы всё равно узнаем это через openedByScheme (visHandler),
          // но пользователь уже в приложении; результат он увидит, когда вернётся назад.
        } // Конец цикла for
      } finally { // Этот блок выполнится всегда, даже если что-то пошло не так
        document.removeEventListener("visibilitychange", visHandler); // Снимаем обработчик видимости, чтобы не мешал дальше
        testing = false; // Отмечаем, что тест завершён
        startBtn.disabled = false; // Разблокируем кнопку
      } // Конец finally

      // После завершения перебора сообщаем результат.
      if (openedByScheme) { // Если зафиксировали, что на какой-то схеме страница уходила в фон
        setStatus("успех: похоже, открытие прошло через схему " + openedByScheme); // Обновляем статус как успешный
        logLine("✅ Похоже, приложение открылось на схеме: " + openedByScheme); // Пишем в лог успех
        logLine("Подсказка: теперь эту схему можно использовать в своих ссылках вместо sberbankonline://"); // Пишем подсказку
      } else { // Если ни одна схема не привела к уходу страницы в фон
        setStatus("не удалось: ни одна схема не дала признаков открытия"); // Статус неуспеха
        logLine("❌ Не увидел признаков открытия приложения ни на одной схеме."); // Пишем в лог
        logLine("Вариант: Сбер у тебя открывается только через HTTPS Universal Link / smartlink (pbpn), а не через custom-scheme напрямую."); // Пояснение
      } // Конец if/else
    } // Конец runTest

    // -----------------------------
    // 8) ЗАПУСК ТЕСТА ПО НАЖАТИЮ (ОДИН ТАП)
    // -----------------------------
    // Важно: iOS чаще разрешает открытие приложений, если это инициировано пользовательским жестом.
    // Поэтому мы запускаем перебор по нажатию на кнопку.

    startBtn.addEventListener("click", () => { // Вешаем обработчик на клик/тап по кнопке
      runTest(); // Запускаем тест
    }); // Конец обработчика кнопки

    // На всякий случай покажем в лог, что страница готова.
    setStatus("готово — нажми «Запустить тест»"); // Ставим статус “готово”
    logLine("Готово. Нажми кнопку запуска, чтобы перебрать схемы."); // Пишем стартовую строку лога

  </script> <!-- Конец JS -->
</body> <!-- Конец body -->
</html> <!-- Конец html -->
