<!doctype html> <!-- Говорим браузеру: это HTML5 документ -->
<html lang="ru"> <!-- Указываем язык страницы (русский) -->
<head> <!-- Начало "головы" документа: метаданные, заголовок -->
  <meta charset="utf-8"> <!-- Кодировка UTF-8, чтобы не ломались русские буквы -->
  <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Корректный масштаб на iPhone -->
  <title>Redirect</title> <!-- Заголовок вкладки (не критично) -->

  <style> /* Небольшие стили, чтобы если фолбэк покажется — выглядело нормально */
    body { /* Стили для всего тела страницы */
      margin: 0; /* Убираем стандартные отступы */
      padding: 24px; /* Делаем удобные поля */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; /* Системный шрифт */
      background: #f6f7f9; /* Светлый фон */
      color: #111; /* Тёмный текст */
    }
    .card { /* Карточка с текстом (видна только если диплинк не сработал) */
      max-width: 520px; /* Ограничиваем ширину */
      margin: 0 auto; /* Центрируем по горизонтали */
      background: #fff; /* Белый фон карточки */
      border-radius: 16px; /* Скругление */
      padding: 18px; /* Внутренние отступы */
      box-shadow: 0 8px 22px rgba(0,0,0,0.10); /* Лёгкая тень */
    }
    code { /* Блок для вывода ссылки */
      display: block; /* Делаем блочным элементом */
      margin-top: 10px; /* Отступ сверху */
      padding: 10px; /* Внутренние отступы */
      background: #f1f3f5; /* Серый фон */
      border-radius: 10px; /* Скругление */
      overflow-x: auto; /* Прокрутка по горизонтали для длинного URL */
      white-space: pre; /* Не переносим строку автоматически */
      font-size: 12px; /* Мелкий шрифт */
    }
    a { /* Ссылки */
      color: #0a66c2; /* Синий цвет */
      text-decoration: none; /* Убираем подчёркивание */
    }
  </style> <!-- Конец CSS -->
</head> <!-- Конец head -->

<body> <!-- Начало тела страницы -->
  <div class="card"> <!-- Карточка с диагностикой/фолбэком -->
    <div id="status">Пытаемся открыть приложение…</div> <!-- Статус (обновим из JS) -->
    <code id="dbg"></code> <!-- Сюда выведем диплинк, чтобы видеть, что реально формируется -->
    <div style="margin-top:12px;font-size:13px;color:#333;line-height:1.45;">
      Если приложение не открылось автоматически, через секунду будет переход на официальный smartlink.
      Если и он не открыл — нажми:
      <a id="fallbackLink" href="#">открыть через официальный smartlink</a>
    </div>
  </div>

  <script>
    // -----------------------------
    // 1) ПОДСТАВЬ СВОИ ДАННЫЕ ЗДЕСЬ
    // -----------------------------

    const PHONE_NUMBER = "79160794459"; // <-- Номер в формате 79XXXXXXXXX (как у тебя)
    const EXTERNAL_SOURCE_RAW = "pbpn-_-test"; // <-- Трекинг-строка (может содержать спецсимволы — мы её закодируем)

    // -----------------------------
    // 2) СОБИРАЕМ ДИПЛИНК (ТОЧНО ОДНОЙ СТРОКОЙ, БЕЗ ПРОБЕЛОВ/ПЕРЕНОСОВ)
    // -----------------------------

    const deepLinkBase = "sberbankonline://payments/p2p-by-phone-number"; // <-- Схема + путь, который должен понимать СберБанк Онлайн
    const sourceValue = "QR_FROM_SELF_EMPLOYED_EXTERNAL"; // <-- Источник сценария, как в официальной pbpn-странице

    const deepLink = // <-- Итоговый диплинк, который отправим в систему iOS
      deepLinkBase + // Добавляем базу
      "?source=" + encodeURIComponent(sourceValue) + // Добавляем source и кодируем на всякий случай
      "&phoneNumber=" + encodeURIComponent(PHONE_NUMBER) + // Добавляем phoneNumber и кодируем
      "&external_source=" + encodeURIComponent(EXTERNAL_SOURCE_RAW); // Добавляем external_source и ОБЯЗАТЕЛЬНО кодируем

    // Показываем диплинк на странице (для контроля — это не влияет на открытие)
    document.getElementById("dbg").textContent = deepLink; // Выводим реально собранную строку диплинка

    // -----------------------------
    // 3) ГОТОВИМ ФОЛБЭК НА ОФИЦИАЛЬНУЮ pbpn-ССЫЛКУ (ОНА У ТЕБЯ ТОЧНО РАБОТАЕТ)
    // -----------------------------

    const fallbackHttps = // <-- HTTPS-ссылка на официальный смартлинк Сбера (он сам разрулит окружение)
      "https://www.sberbank.com/sms/pbpn?requisiteNumber=" + encodeURIComponent(PHONE_NUMBER); // Подставляем номер как requisiteNumber

    // Делает кликабельную ссылку на фолбэк (если пользователь захочет нажать вручную)
    const fallbackA = document.getElementById("fallbackLink"); // Берём элемент ссылки
    fallbackA.href = fallbackHttps; // Ставим туда фолбэк URL

    // -----------------------------
    // 4) ЛОГИКА АВТО-РЕДИРЕКТА
    // -----------------------------
    // На iOS иногда автозапуск кастомных схем может быть ограничен.
    // Поэтому:
    //  - сначала пробуем открыть deepLink,
    //  - если страница не "ушла" в приложение, через короткое время идём на fallbackHttps.

    let fallbackTimer = null; // Таймер для фолбэка (чтобы можно было отменить)
    let openedApp = false; // Флаг: похоже ли, что приложение открылось

    function clearFallbackTimer() { // Функция: безопасно отменить таймер фолбэка
      if (fallbackTimer !== null) { // Если таймер был установлен
        clearTimeout(fallbackTimer); // Отменяем его
        fallbackTimer = null; // И обнуляем переменную
      }
    }

    function markAsOpened() { // Функция: пометить, что приложение, вероятно, открылось
      openedApp = true; // Ставим флаг
      clearFallbackTimer(); // Отменяем фолбэк, чтобы не перешло обратно на https
      document.getElementById("status").textContent = "Приложение открывается…"; // Обновляем статус на странице
    }

    // В iOS при уходе в приложение документ часто становится hidden (страница уходит в фон).
    document.addEventListener("visibilitychange", () => { // Слушаем событие изменения видимости страницы
      if (document.hidden) { // Если страница стала "невидимой" (ушла в фон)
        markAsOpened(); // Считаем это признаком, что приложение открылось
      }
    });

    // Пробуем открыть приложение
    function tryOpenApp() { // Функция: попытка открыть диплинк
      document.getElementById("status").textContent = "Пытаемся открыть приложение по диплинку…"; // Пишем статус
      // ВАЖНО: используем location.replace, чтобы не засорять историю браузера
      window.location.replace(deepLink); // Передаём диплинк в систему iOS (если схема зарегистрирована — откроется приложение)
    }

    // Ставим фолбэк: если за 1200 мс приложение “не открылось”, идём на официальный HTTPS смартлинк.
    function scheduleFallback() { // Функция: запланировать фолбэк
      clearFallbackTimer(); // Сначала отменяем старый таймер, если был
      fallbackTimer = setTimeout(() => { // Ставим новый таймер
        if (!openedApp) { // Если мы не увидели признаков открытия приложения
          document.getElementById("status").textContent = "Авто-открытие заблокировано. Переходим на официальный smartlink…"; // Пишем статус
          window.location.replace(fallbackHttps); // Переходим на официальный смартлинк (он у тебя точно открывает приложение)
        }
      }, 1200); // 1.2 секунды — обычно достаточно, чтобы Safari ушёл в приложение, если диплинк разрешён
    }

    // Запускаем всё сразу после загрузки DOM
    document.addEventListener("DOMContentLoaded", () => { // Ждём, пока страница и элементы будут готовы
      scheduleFallback(); // Сначала ставим фолбэк на случай блокировки
      // Иногда помогает небольшая задержка в 50–150 мс, чтобы Safari успел отрисовать страницу
      setTimeout(tryOpenApp, 80); // Через 80 мс пытаемся открыть приложение
    });
  </script>
</body> <!-- Конец body -->
</html> <!-- Конец html -->
